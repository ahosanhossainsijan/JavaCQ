trigger:
  - master

variables:
  isMain: $[eq(variables['Build.SourceBranch'], 'refs/heads/master')]

stages:
  - stage: Build
    jobs:
      - job: BuildJob
        pool: mypool
        steps:
          - task: Maven@3
            inputs:
              mavenVersionOption: 'SpecificVersion'
              mavenVersion: '3.9.4'
              mavenPomFile: 'pom.xml'
              mavenOptions: '-Xmx3072m'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '17'
              jdkArchitectureOption: 'x64'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              goals: 'package'

          - task: CopyFiles@2
            inputs:
              contents: '**/target/*.jar'
              targetFolder: '$(build.artifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'drop'

  - stage: Test
    jobs:
      - job: TestJob
        pool: mypool
        steps:
          - task: Maven@3
            inputs:
              mavenVersionOption: 'SpecificVersion'
              mavenVersion: '3.9.4'
              mavenPomFile: 'pom.xml'
              mavenOptions: '-Xmx3072m'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '17'
              jdkArchitectureOption: 'x64'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              goals: 'test'

          # Download and extract Allure CLI
          - powershell: |
              Invoke-WebRequest -Uri https://github.com/allure-framework/allure2/releases/download/2.20.0/allure-2.20.0.zip -OutFile $(Build.SourcesDirectory)\allure.zip
              Expand-Archive -Path $(Build.SourcesDirectory)\allure.zip -DestinationPath $(Build.SourcesDirectory)\allure
            displayName: 'Download and Extract Allure CLI'

          # Generate Allure report
          - powershell: |
              $(Build.SourcesDirectory)\allure\allure-2.20.0\bin\allure generate $(Build.SourcesDirectory)\target\allure-results -o $(Build.SourcesDirectory)\allure-report
            displayName: 'Generate Allure Report'

          # Publish Allure report as a build artifact
          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.SourcesDirectory)\allure-results'
              artifactName: 'allure-results'

  - stage: NotifySuccess
    condition: succeeded()
    jobs:
      - job: NotifyJob
        pool: mypool
        steps:
          - script: echo Build was successful!
            displayName: 'Print success message'
